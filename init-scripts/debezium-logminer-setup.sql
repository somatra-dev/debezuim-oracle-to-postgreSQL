WHENEVER SQLERROR EXIT FAILURE

-- =========================
-- STAGE 1: FRA & ARCHIVELOG
-- =========================

ALTER SYSTEM SET db_recovery_file_dest_size = 10G SCOPE=BOTH;

DECLARE
  v_log_mode VARCHAR2(12);
BEGIN
  SELECT LOG_MODE INTO v_log_mode FROM V$DATABASE;
  IF v_log_mode != 'ARCHIVELOG' THEN
    EXECUTE IMMEDIATE 'SHUTDOWN IMMEDIATE';
    EXECUTE IMMEDIATE 'STARTUP MOUNT';
    EXECUTE IMMEDIATE 'ALTER DATABASE ARCHIVELOG';
    EXECUTE IMMEDIATE 'ALTER DATABASE OPEN';
  END IF;
END;
/

-- =========================
-- STAGE 2: SUPPLEMENTAL LOGGING
-- =========================

ALTER DATABASE ADD SUPPLEMENTAL LOG DATA;
ALTER DATABASE ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

ALTER DATABASE FORCE LOGGING;

-- =========================
-- STAGE 3: LOGMINER TABLESPACE
-- =========================

BEGIN
  EXECUTE IMMEDIATE
    'CREATE TABLESPACE LOGMINER_TBS
     DATAFILE ''/opt/oracle/oradata/ORCLCDB/logminer_tbs.dbf''
     SIZE 25M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -959 THEN RAISE; END IF;
END;
/

ALTER SESSION SET CONTAINER = ORCLPDB1;

BEGIN
  EXECUTE IMMEDIATE
    'CREATE TABLESPACE LOGMINER_TBS
     DATAFILE ''/opt/oracle/oradata/ORCLCDB/ORCLPDB1/logminer_tbs.dbf''
     SIZE 25M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -959 THEN RAISE; END IF;
END;
/

ALTER SESSION SET CONTAINER = CDB$ROOT;

-- =========================
-- STAGE 4: CDC USER
-- =========================

BEGIN
  EXECUTE IMMEDIATE '
    CREATE USER c##dbzuser IDENTIFIED BY dbz
    DEFAULT TABLESPACE LOGMINER_TBS
    QUOTA UNLIMITED ON LOGMINER_TBS
    CONTAINER=ALL';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -1920 THEN RAISE; END IF;
END;
/

-- Grants for c##dbzuser
GRANT CREATE SESSION TO c##dbzuser CONTAINER=ALL;
GRANT SET CONTAINER TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$DATABASE TO c##dbzuser CONTAINER=ALL;
GRANT FLASHBACK ANY TABLE TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ANY TABLE TO c##dbzuser CONTAINER=ALL;
GRANT SELECT_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE_CATALOG_ROLE TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ANY TRANSACTION TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ANY DICTIONARY TO c##dbzuser CONTAINER=ALL;
GRANT LOGMINING TO c##dbzuser CONTAINER=ALL;

GRANT CREATE TABLE TO c##dbzuser CONTAINER=ALL;
GRANT LOCK ANY TABLE TO c##dbzuser CONTAINER=ALL;
GRANT CREATE SEQUENCE TO c##dbzuser CONTAINER=ALL;

GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE ON DBMS_LOGMNR_D TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_LOGS TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGFILE TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$ARCHIVED_LOG TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO c##dbzuser CONTAINER=ALL;

-- grants for robustness
GRANT SELECT ON V_$LOG TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOG_HISTORY TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$INSTANCE TO c##dbzuser CONTAINER=ALL;

-- =========================
-- STAGE 5: APPLICATION USER
-- =========================

ALTER SESSION SET CONTAINER = ORCLPDB1;


BEGIN
  EXECUTE IMMEDIATE 'CREATE USER debezium IDENTIFIED BY dbz';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -1920 THEN RAISE; END IF;
END;
/

GRANT CREATE SESSION, CREATE TABLE, CREATE SEQUENCE TO debezium;
ALTER USER debezium QUOTA 100M ON users;

-- =========================
-- STAGE 6: SAMPLE TABLE
-- =========================

-- Create sample tables (as debezium user)
CONNECT debezium/dbz@//localhost:1521/ORCLPDB1

-- Products table
CREATE TABLE products (
  id NUMBER(4) GENERATED BY DEFAULT ON NULL AS IDENTITY (START WITH 101) NOT NULL PRIMARY KEY,
  name VARCHAR2(255) NOT NULL,
  description VARCHAR2(512),
  weight FLOAT
);

ALTER TABLE products ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
GRANT SELECT ON products TO c##dbzuser;

-- Insert sample data
INSERT INTO products VALUES (NULL,'scooter','Small 2-wheel scooter',3.14);
INSERT INTO products VALUES (NULL,'car battery','12V car battery',8.1);
COMMIT;

SHOW PARAMETER recovery;

EXIT;
